import{s as l}from"./supabase-qYfXH0FQ.js";import{E as M}from"./asistencia-CclXGOEn.js";class w{constructor(e,t){this.id=e,this.labels=t,this.records=new Map}records;static baseHeaders=[];getLabels(){return this.labels}set(e,t){this.records.set(e,t)}get(e){return this.records.get(e)}getRecords(){return this.records}}var c=(n=>(n.Presente="presente",n.Ausente="ausente",n.Tarde="tarde",n.Excusa="excusa",n))(c||{});class u extends w{constructor(e,t,r){super(e,[t,r]),this.nombre=t,this.apellido=r,Object.values(c).forEach(s=>{this.set(s,0)})}static baseHeaders=["Nombre","Apellido"];toRow(){const e=Object.values(c).map(t=>String(this.get(t)??0));return[...this.labels,...e]}getHeaders(){const e=Object.values(c).map(t=>t.charAt(0).toUpperCase()+t.slice(1));return[...u.baseHeaders,...e]}}class R extends u{toRow(){const e=Object.values(c),t=e.reduce((s,a)=>s+(this.get(a)??0),0),r=e.map(s=>{const a=this.get(s)??0;return t>0?String(a*100/t)+"%":"0%"});return[...this.labels,...r]}}class h{reports=[];static build(e,t){const r=new Map;return e.forEach(s=>{let a=r.get(s.materia);a||(a=new Map,r.set(s.materia,a));let o=a.get(s.id);o||(o=t(s.id,s.nombre,s.apellido),a.set(s.id,o)),o.set(s.estado,s.count)}),r}static buildAll(e){return{total:h.build(e,(t,r,s)=>new u(t,r,s)),porcentajes:h.build(e,(t,r,s)=>new R(t,r,s))}}}class m extends w{constructor(e,t,r,s){super(e,[t,r]),this.nombre=t,this.apellido=r,this.fechas=s,s.forEach(a=>{this.set(a,c.Ausente)})}static baseHeaders=["Nombre","Apellido"];toRow(){const e=this.fechas.map(t=>(this.get(t)??c.Ausente).toUpperCase());return[...this.labels,...e]}getHeaders(){return[...m.baseHeaders,...this.fechas]}}class C{static build(e){const t=new Map,r=new Map;return e.forEach(s=>{let a=r.get(s.materia);a||(a=new Set),a.add(s.fecha),r.set(s.materia,a)}),e.forEach(s=>{let a=t.get(s.materia);a||(a=new Map,t.set(s.materia,a));let o=a.get(s.id);o||(o=new m(s.id,s.nombre,s.apellido,Array.from(r.get(s.materia))),a.set(s.id,o)),o.set(s.fecha,s.estado)}),t}}const f=["resumen","materias","alertas"];function y(n){return f.includes(n)}class V{activeTab="resumen";setActiveTab(e){this.activeTab=e}getActiveTab(){return this.activeTab}}class x{constructor(e,t){this.reportesPorMateria=e,this.reportesPorFecha=t}reportMode="total";toggleMode(){this.reportMode=this.reportMode==="total"?"porcentajes":"total"}getMaterias(){return Array.from(this.reportesPorMateria[this.reportMode].keys())}getReportesDeMateria(e){return this.reportesPorMateria[this.reportMode].get(e)}getReportesPorFecha(e){return this.reportesPorFecha.get(e)}}class g{root;container;constructor(e,t){if(t){const s=document.getElementById(t);if(!s)throw new Error(`Container ${t} not found`);this.container=s}const r=document.getElementById(e);if(!r)throw new Error(`Root ${e} not found`);this.root=r}clear(){this.root.innerHTML=""}show(){this.container&&(this.container.classList.add("activo"),this.container.classList.remove("inactivo"))}hide(){this.container&&(this.container.classList.add("inactivo"),this.container.classList.remove("activo"))}}class v{rowRenderer(e,t){const r=document.createElement("tr");return e.forEach(s=>{r.appendChild(this.renderCell(s,t))}),r}renderCell(e,t){const r=document.createElement(t);return r.innerText=e,r}headerRenderer(e){const t=document.createElement("thead"),r=this.rowRenderer(e,"th");return t.appendChild(r),t}bodyRenderer(e){const t=document.createElement("tbody");return e.forEach((r,s)=>{const a=r.toRow(),o=this.rowRenderer(a,"td");o.dataset.id=s,t.appendChild(o)}),t}render(e){const t=document.createElement("table"),[r]=e.values();if(!r)return t;const s=this.headerRenderer(r.getHeaders());t.appendChild(s);const a=this.bodyRenderer(e);return t.appendChild(a),t}}class P extends g{tableView=new v;constructor(e,t){super(e,t)}render(e){this.clear(),e.getMaterias().forEach(r=>{const s=this.createSection(r),a=e.getReportesDeMateria(r);if(a){const o=this.tableView.render(a);o.className="reportTable",s.appendChild(o)}this.root.appendChild(s)})}createSection(e){const t=document.createElement("section"),r=document.createElement("h2");return r.innerText=e,r.className="sectionTitle",t.appendChild(r),t}}class S extends v{renderCell(e,t){const r=document.createElement(t);return r.innerText=e,r.className=e.toLowerCase(),r}}class B extends g{tableView=new S;constructor(e){super(e)}render(e){this.clear(),e.getMaterias().forEach(r=>{const s=this.createSection(r),a=e.getReportesPorFecha(r);if(a){const o=this.tableView.render(a);o.className="reportTable",s.appendChild(o)}this.root.appendChild(s)})}createSection(e){const t=document.createElement("section"),r=document.createElement("h2");return r.innerText=e,r.className="sectionTitle",t.appendChild(r),t}}class H{constructor(e){this.vm=e}state=new V;tabViews=[new P("tab-resumen","sectionContainer"),new B("tab-materias")];init(){this.bindTabs(),this.renderActiveTab(),this.bindButtons()}bindTabs(){document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");if(!y(t))throw new Error("This is not a tab");this.state.setActiveTab(t),this.renderActiveTab()})})}renderActiveTab(){const e=this.state.getActiveTab(),t=document.querySelector(`[data-tab='${e}']`);if(!t)throw new Error("Tab doesn't exist");switch(this.clearAll(),t.className="tab active",e){case"resumen":this.tabViews[0].show(),this.tabViews[0].render(this.vm);break;case"materias":this.tabViews[0].hide(),this.tabViews[1].render(this.vm);break}}clearAll(){Object.values(f).forEach(e=>{const t=document.querySelector(`[data-tab='${e}']`);t&&(t.className="tab")}),this.tabViews.forEach(e=>e.clear())}bindButtons(){document.getElementById("toggleReportBtn")?.addEventListener("click",()=>{this.vm.toggleMode(),this.renderActiveTab()})}}const L=new URLSearchParams(window.location.search),d=L.get("grupo_id");async function D(){const{data:{user:n}}=await l.auth.getUser();if(!n){location.replace("index.html");return}if(!d){alert("Debe especificar una id de grupo");return}const{data:e}=await l.from("grupos").select("*").eq("id",d).single(),t=document.getElementById("dash-subtitle");t.innerText=`Grupo: ${e?.nombre}`;let r,s;const{data:a,error:o}=await l.from("asistencias_por_dia").select("*").eq("grupo_id",d);o&&alert(o.message),a?r=a?.map(i=>({nombre:i.nombre??"",apellido:i.apellido??"",estado:i.estado||M.Ausente,fecha:i.fecha??"2026-01-01",id:i.id??"",materia:i.materia??""})):r=[];const{data:p,error:b}=await l.from("asistencias_resumen").select("*").eq("grupo_id",d);b&&alert(b.message),p?s=p?.map(i=>({id:i.estudiante_id,nombre:i.nombre,apellido:i.apellido,estado:i.estado,materia:i.materia,count:i.total})):s=[];const E=h.buildAll(s),T=C.build(r),A=new x(E,T);new H(A).init(),document.body.style.opacity="1"}D();
