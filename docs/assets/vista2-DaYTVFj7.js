import{s as d}from"./supabase-CIXc0Sbq.js";import{E as l,A as E}from"./asistencia-CclXGOEn.js";const s={asistencias:new Map},_=new URLSearchParams(window.location.search),m=_.get("dmg_id");let i=null,c=null,p=null,f=null;const g=new Date().toISOString().slice(0,10);document.addEventListener("DOMContentLoaded",h);document.getElementById("allPresent").addEventListener("click",b);document.getElementById("allAbsent").addEventListener("click",v);document.getElementById("saveButton").addEventListener("click",L);document.getElementById("cancelButton").addEventListener("click",()=>{location.replace("clases.html")});async function h(){if(!m){alert("Falta el ID de asignaciÃ³n docente "),location.replace("clases.html");return}const{data:e,error:t}=await d.from("vista_clases_docente").select("grupo_id, materia_id, grupo, materia").eq("dmg_id",m).single();if(t){alert(t.message);return}i=e.grupo_id,c=e.materia_id,p=e.grupo,f=e.materia,i&&(document.getElementById("titulo").innerText=`Asistencia ${g} | Grupo: ${p} - Materia: ${f}`,await y(i),u())}async function y(e){const{data:t,error:a}=await d.from("estudiantes").select("id, nombre, apellido").eq("grupo_id",e).eq("activo",!0).order("apellido",{ascending:!0}).order("nombre",{ascending:!0});if(a){alert(a.message);return}t.forEach(n=>{s.asistencias.set(n.id,{nombre:`${n.apellido} ${n.nombre}`,estado:l.Presente})})}function u(){const e=document.getElementById("lista");e.innerHTML="",s.asistencias.forEach((t,a)=>{const n=document.createElement("div");n.className="fila";const r=document.createElement("span");r.className="nombre",r.textContent=t.nombre;const o=document.createElement("span");o.className=`estado ${t.estado}`,o.textContent=" "+t.estado.toUpperCase(),o.dataset.id=a,n.appendChild(r),n.appendChild(o),e.appendChild(n)}),document.body.style.opacity="1"}document.addEventListener("click",e=>{const t=e.target;if(t&&t.classList.contains("estado")){const a=t.dataset.id;if(!a)return;w(a)}});function b(){s.asistencias.forEach(e=>e.estado=l.Presente),u()}function v(){s.asistencias.forEach(e=>e.estado=l.Ausente),u()}async function L(){if(!i||!c)return;const{error:e}=await d.rpc("guardar_asistencia_mvp",{p_grupo_id:i,p_materia_id:c,p_fecha:g,p_asistencias:B(s.asistencias)});e?alert(e.message):(alert("Asistencia guardada correctamente"),location.replace("clases.html"))}function w(e){const t=s.asistencias.get(e);t&&(t.estado=E.next(t.estado),A(e,t.estado))}function A(e,t){const a=document.querySelector(`[data-id="${e}"]`);a&&(a.className=`estado ${t}`,a.innerText=t.toUpperCase())}function B(e){const t=[];return e.forEach((a,n)=>{t.push({estudiante_id:n,estado:a.estado})}),t}
