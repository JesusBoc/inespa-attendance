import{s as h}from"./supabase-CIXc0Sbq.js";import{E as C}from"./asistencia-CclXGOEn.js";class v{constructor(e,t){this.id=e,this.labels=t,this.records=new Map}records;static baseHeaders=[];getLabels(){return this.labels}set(e,t){this.records.set(e,t)}get(e){return this.records.get(e)}getRecords(){return this.records}}var c=(n=>(n.Presente="presente",n.Ausente="ausente",n.Tarde="tarde",n.Excusa="excusa",n))(c||{});class m extends v{constructor(e,t,r){super(e,[t,r]),this.nombre=t,this.apellido=r,Object.values(c).forEach(s=>{this.set(s,0)})}static baseHeaders=["Nombre","Apellido"];toRow(){const e=Object.values(c).map(t=>String(this.get(t)??0));return[...this.labels,...e]}getHeaders(){const e=Object.values(c).map(t=>t.charAt(0).toUpperCase()+t.slice(1));return[...m.baseHeaders,...e]}}class S extends m{toRow(){const e=Object.values(c),t=e.reduce((s,a)=>s+(this.get(a)??0),0),r=e.map(s=>{const a=this.get(s)??0;return t>0?String(a*100/t)+"%":"0%"});return[...this.labels,...r]}}class p{reports=[];static build(e,t){const r=new Map;return e.forEach(s=>{let a=r.get(s.materia);a||(a=new Map,r.set(s.materia,a));let i=a.get(s.id);i||(i=t(s.id,s.nombre,s.apellido),a.set(s.id,i)),i.set(s.estado,s.count)}),r}static buildAll(e){return{total:p.build(e,(t,r,s)=>new m(t,r,s)),porcentajes:p.build(e,(t,r,s)=>new S(t,r,s))}}}class b extends v{constructor(e,t,r,s){super(e,[t,r]),this.nombre=t,this.apellido=r,this.fechas=s,s.forEach(a=>{this.set(a,c.Ausente)})}static baseHeaders=["Nombre","Apellido"];toRow(){const e=this.fechas.map(t=>(this.get(t)??c.Ausente).toUpperCase());return[...this.labels,...e]}getHeaders(){return[...b.baseHeaders,...this.fechas]}}class j{static build(e){const t=new Map,r=new Map;return e.forEach(s=>{let a=r.get(s.materia);a||(a=new Set),a.add(s.fecha),r.set(s.materia,a)}),e.forEach(s=>{let a=t.get(s.materia);a||(a=new Map,t.set(s.materia,a));let i=a.get(s.id);i||(i=new b(s.id,s.nombre,s.apellido,Array.from(r.get(s.materia))),a.set(s.id,i)),i.set(s.fecha,s.estado)}),t}}const E=["resumen","materias","alertas"];function x(n){return E.includes(n)}class P{activeTab="resumen";setActiveTab(e){this.activeTab=e}getActiveTab(){return this.activeTab}}class w{constructor(e){this.rules=e}evaluate(e){const t=new Map;return this.rules.forEach(r=>{t.set(r.type,r.evaluate(e))}),t}}class f{constructor(e){this.data=e}getReport(e,t){return this.data.get(e)?.get(t)}getReportsBySubject(e){return this.data.get(e)?.values().toArray()??[]}getSubjects(){return this.data.keys().toArray()}}class A{static type;evaluate(e){return e.getSubjects().map(s=>[s,e.getReportsBySubject(s)]).flatMap(([s,a])=>this.evaluateSubject([s,a]))}evaluateMetric(e,t,r){return this.shouldAlert(e)?[this.buildAlert(e,t,r)]:[]}}class V extends A{type="inasistencia_consecutiva";evaluateSubject([e,t]){return t.flatMap(s=>{let a=0;const i=s.getRecords().values().toArray().reverse();for(const l of i){if(l===c.Presente||l===c.Tarde)break;a++}return this.evaluateMetric(a,s.getLabels(),e)})}shouldAlert(e){return e>=2}getSeverity(e){return e===3?"medium":e>3?"high":"low"}buildAlert(e,t,r){return{type:this.type,severity:this.getSeverity(e),message:`${t.join(" ")} ha faltado ${e} veces seguidas a ${r}`}}}class L extends A{type="bajo_porcentaje_de_asistencia";lowThreshold=.1;medThreshold=.2;highThreshold=.3;evaluateSubject([e,t]){return t.flatMap(r=>{const s=Array.from(r.getRecords().values()).reduce((i,l)=>i+l,0);if(s===0)return[];const a=(r.get(c.Ausente)??0)/s;return this.evaluateMetric(a,r.getLabels(),e)})}shouldAlert(e){return e>=this.lowThreshold}getSeverity(e){return e>=this.highThreshold?"high":e>=this.medThreshold?"medium":"low"}buildAlert(e,t,r){return{type:this.type,severity:this.getSeverity(e),message:`${t.join(" ")} ha faltado al ${(e*100).toFixed(1)}% de las clases de ${r}`}}}class N{constructor(e,t){this.reportesPorMateria=e,this.reportesPorFecha=t}reportMode="total";alertEngines={aggregate:new w([new L]),temporal:new w([new V])};toggleMode(){this.reportMode=this.reportMode==="total"?"porcentajes":"total"}getMaterias(){return Array.from(this.reportesPorMateria[this.reportMode].keys())}getReportesDeMateria(e){return this.reportesPorMateria[this.reportMode].get(e)}getReportesPorFecha(e){return this.reportesPorFecha.get(e)}getAggregateReports(){return this.reportesPorMateria.total}getTemporalReports(){return this.reportesPorFecha}getAlertEngines(){return this.alertEngines}}class g{root;container;constructor(e,t){if(t){const s=document.getElementById(t);if(!s)throw new Error(`Container ${t} not found`);this.container=s}const r=document.getElementById(e);if(!r)throw new Error(`Root ${e} not found`);this.root=r}clear(){this.root.innerHTML=""}show(){this.container&&(this.container.classList.add("activo"),this.container.classList.remove("inactivo"))}hide(){this.container&&(this.container.classList.add("inactivo"),this.container.classList.remove("activo"))}}class T{rowRenderer(e,t){const r=document.createElement("tr");return e.forEach(s=>{r.appendChild(this.renderCell(s,t))}),r}renderCell(e,t){const r=document.createElement(t);return r.innerText=e,r}headerRenderer(e){const t=document.createElement("thead"),r=this.rowRenderer(e,"th");return t.appendChild(r),t}bodyRenderer(e){const t=document.createElement("tbody");return e.forEach((r,s)=>{const a=r.toRow(),i=this.rowRenderer(a,"td");i.dataset.id=s,t.appendChild(i)}),t}render(e){const t=document.createElement("table"),[r]=e.values();if(!r)return t;const s=this.headerRenderer(r.getHeaders());t.appendChild(s);const a=this.bodyRenderer(e);return t.appendChild(a),t}}class B extends g{tableView=new T;constructor(e,t){super(e,t)}render(e){this.clear(),e.getMaterias().forEach(r=>{const s=this.createSection(r),a=e.getReportesDeMateria(r);if(a){const i=this.tableView.render(a);i.className="reportTable",s.appendChild(i)}this.root.appendChild(s)})}createSection(e){const t=document.createElement("section"),r=document.createElement("h2");return r.innerText=e,r.className="sectionTitle",t.appendChild(r),t}}class _ extends T{renderCell(e,t){const r=document.createElement(t);return r.innerText=e,r.className=e.toLowerCase(),r}}class $ extends g{tableView=new _;constructor(e){super(e)}render(e){this.clear(),e.getMaterias().forEach(r=>{const s=this.createSection(r),a=e.getReportesPorFecha(r);if(a){const i=this.tableView.render(a);i.className="reportTable",s.appendChild(i)}this.root.appendChild(s)})}createSection(e){const t=document.createElement("section"),r=document.createElement("h2");return r.innerText=e,r.className="sectionTitle",t.appendChild(r),t}}const H={bajo_porcentaje_de_asistencia:"Bajo porcentaje de asistencia",inasistencia_consecutiva:"Muchas inasistencias seguidas"};function D(n){return H[n]??n}class F extends g{render(e){const t=new f(e.getAggregateReports()),r=new f(e.getTemporalReports()),s=e.getAlertEngines();[...s.aggregate.evaluate(t).entries(),...s.temporal.evaluate(r).entries()].forEach(([i,l])=>{const d=this.createSection(D(i));d.appendChild(this.createAlertList(l)),this.root.appendChild(d)})}createSection(e){const t=document.createElement("section"),r=document.createElement("h2");return r.innerText=e,r.className="sectionTitle",t.appendChild(r),t}createAlertList(e){const t=document.createElement("ul");if(t.className="alertList",e.length===0){const r=document.createElement("li");return r.textContent="No hay alertas de este tipo",r.className="noAlerts",t.appendChild(r),t}return e.forEach(r=>{const s=document.createElement("li");s.textContent=r.message,s.className=r.severity,t.appendChild(s)}),t}}class k{constructor(e){this.vm=e}state=new P;tabViews=[new B("tab-resumen","sectionContainer"),new $("tab-materias"),new F("tab-alertas")];init(){this.bindTabs(),this.renderActiveTab(),this.bindButtons()}bindTabs(){document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");if(!x(t))throw new Error("This is not a tab");this.state.setActiveTab(t),this.renderActiveTab()})})}renderActiveTab(){const e=this.state.getActiveTab(),t=document.querySelector(`[data-tab='${e}']`);if(!t)throw new Error("Tab doesn't exist");switch(this.clearAll(),t.className="tab active",e){case"resumen":this.tabViews[0].show(),this.tabViews[0].render(this.vm);break;case"materias":this.tabViews[0].hide(),this.tabViews[1].render(this.vm);break;case"alertas":this.tabViews[0].hide(),this.tabViews[2].render(this.vm)}}clearAll(){Object.values(E).forEach(e=>{const t=document.querySelector(`[data-tab='${e}']`);t&&(t.className="tab")}),this.tabViews.forEach(e=>e.clear())}bindButtons(){document.getElementById("toggleReportBtn")?.addEventListener("click",()=>{this.vm.toggleMode(),this.renderActiveTab()})}}const q=new URLSearchParams(window.location.search),u=q.get("grupo_id");async function O(){const{data:{user:n}}=await h.auth.getUser();if(!n){location.replace("index.html");return}if(!u){alert("Debe especificar una id de grupo");return}const{data:e}=await h.from("grupos").select("*").eq("id",u).single(),t=document.getElementById("dash-subtitle");t.innerText=`Grupo: ${e?.nombre}`;let r,s;const{data:a,error:i}=await h.from("asistencias_por_dia").select("*").eq("grupo_id",u);i&&alert(i.message),a?r=a?.map(o=>({nombre:o.nombre??"",apellido:o.apellido??"",estado:o.estado||C.Ausente,fecha:o.fecha??"2026-01-01",id:o.id??"",materia:o.materia??""})):r=[];const{data:l,error:d}=await h.from("asistencias_resumen").select("*").eq("grupo_id",u);d&&alert(d.message),l?s=l?.map(o=>({id:o.estudiante_id,nombre:o.nombre,apellido:o.apellido,estado:o.estado,materia:o.materia,count:o.total})):s=[];const y=p.buildAll(s),M=j.build(r),R=new N(y,M);new k(R).init(),document.body.style.opacity="1"}O();
