import{s as d}from"./supabase-BZquj9zQ.js";import{E as l,A as E}from"./asistencia-CclXGOEn.js";import{r as _}from"./RoleUtils-Bzeu-8KE.js";const s={asistencias:new Map},h=new URLSearchParams(window.location.search),m=h.get("dmg_id");let i=null,c=null,p=null,f=null;const g=new Date().toISOString().slice(0,10);document.addEventListener("DOMContentLoaded",y);document.getElementById("allPresent").addEventListener("click",v);document.getElementById("allAbsent").addEventListener("click",w);document.getElementById("saveButton").addEventListener("click",L);document.getElementById("cancelButton").addEventListener("click",()=>{location.replace("clases.html")});async function y(){if(!await _())return;if(!m){alert("Falta el ID de asignaciÃ³n docente "),location.replace("clases.html");return}const{data:e,error:a}=await d.from("vista_clases_docente").select("grupo_id, materia_id, grupo, materia").eq("dmg_id",m).single();if(a){alert(a.message);return}i=e.grupo_id,c=e.materia_id,p=e.grupo,f=e.materia,i&&(document.getElementById("titulo").innerText=`Asistencia ${g} | Grupo: ${p} - Materia: ${f}`,await b(i),u())}async function b(t){const{data:e,error:a}=await d.from("estudiantes").select("id, nombre, apellido").eq("grupo_id",t).eq("activo",!0).order("apellido",{ascending:!0}).order("nombre",{ascending:!0});if(a){alert(a.message);return}e.forEach(n=>{s.asistencias.set(n.id,{nombre:`${n.apellido} ${n.nombre}`,estado:l.Presente})})}function u(){const t=document.getElementById("lista");t.innerHTML="",s.asistencias.forEach((e,a)=>{const n=document.createElement("div");n.className="fila";const r=document.createElement("span");r.className="nombre",r.textContent=e.nombre;const o=document.createElement("span");o.className=`estado ${e.estado}`,o.textContent=" "+e.estado.toUpperCase(),o.dataset.id=a,n.appendChild(r),n.appendChild(o),t.appendChild(n)}),document.body.style.opacity="1"}document.addEventListener("click",t=>{const e=t.target;if(e&&e.classList.contains("estado")){const a=e.dataset.id;if(!a)return;A(a)}});function v(){s.asistencias.forEach(t=>t.estado=l.Presente),u()}function w(){s.asistencias.forEach(t=>t.estado=l.Ausente),u()}async function L(){if(!i||!c)return;const{error:t}=await d.rpc("guardar_asistencia_mvp",{p_grupo_id:i,p_materia_id:c,p_fecha:g,p_asistencias:C(s.asistencias)});t?alert(t.message):(alert("Asistencia guardada correctamente"),location.replace("clases.html"))}function A(t){const e=s.asistencias.get(t);e&&(e.estado=E.next(e.estado),B(t,e.estado))}function B(t,e){const a=document.querySelector(`[data-id="${t}"]`);a&&(a.className=`estado ${e}`,a.innerText=e.toUpperCase())}function C(t){const e=[];return t.forEach((a,n)=>{e.push({estudiante_id:n,estado:a.estado})}),e}
